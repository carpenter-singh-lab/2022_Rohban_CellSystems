
```{r}

rm(list = ls())
library(dplyr)
library(stringr)
library(doParallel)
doParallel::registerDoParallel(cores = 4)

whiten <- F
top.p <- 0.01

cdrp <- readRDS("../results/master/2017-04-20_425d653/Pf_bio_new.rds")
feats <- colnames(cdrp)
feats <- feats[which(!str_detect(feats, "Metadata_"))]

if (whiten) {
  cdrp.dmso <- readRDS("../results/master/2017-09-05_da5f3073/Pf_bio_new_all.rds")
  cdrp.dmso <- cdrp.dmso %>% filter(Metadata_ASSAY_WELL_ROLE == "mock") %>% select(one_of(feats))
  mn <- apply(cdrp.dmso, 2, mean)
  cv <- cov(cdrp.dmso)
  ev <- eigen(cv)
  eps <- 10^-1
  W <- diag((ev$values + eps)^-0.5) %*% t(ev$vectors)
  cdrp[, feats] <- t(W %*% (apply(cdrp[, feats], 1, function(x) (x - mn))))
}

brd.to.name <- readr::read_csv("../input/CDP2/cdrp.cpd.meta.csv")
moa <- read.csv("../input/moas.txt", sep = "\t")

moa <- moa %>% 
  mutate(Name.cano = str_to_lower(Name)) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "-", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, " ", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "\\[", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "\\]", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "\\(", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "\\)", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "\\+", "")) 
  
cdrp.profiles <- cdrp %>% 
  group_by(Metadata_broad_sample) %>%
  summarise_at(.vars = feats, .funs = mean) %>%
  mutate(Metadata_broad_id_trunc = str_sub(Metadata_broad_sample, 1, 13)) %>%
  left_join(., brd.to.name, by = c("Metadata_broad_id_trunc" = "BROAD_CPD_ID")) %>% 
  filter(CPD_NAME != "")
  
cdrp.profiles <- cdrp.profiles %>% 
  mutate(Name.cano = str_to_lower(CPD_NAME)) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "-", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, " ", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "\\[", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "\\]", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "\\(", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "\\)", "")) %>%
  mutate(Name.cano = str_replace_all(Name.cano, "\\+", "")) 

moa2 <- readr::read_csv("../input/CDP2/MOA_annot2.csv")
moa2 <- moa2 %>% mutate(Name = ifelse(is.na(Name), CPD_NAME, Name))

cdrp.profiles <- cdrp.profiles %>%
  left_join(., moa2, by = "Metadata_broad_sample") %>%
  filter(!is.na(Name) & !is.na(MOA))

cdrp.profiles <- cdrp.profiles %>% 
  group_by(Metadata_broad_sample) %>%
  slice(1) %>%
  ungroup()

rownames(cdrp.profiles) <- cdrp.profiles$Metadata_broad_sample

same.moa <- function(x, y) {
  if (is.na(x) || is.na(y) || x == "" || y == "") 
    return(FALSE)
  xs <- str_split(x, ", ")[[1]]
  ys <- str_split(y, ", ")[[1]]
  return(any(xs %in% ys) | any(ys %in% xs))
}

same.moa <- Vectorize(same.moa)

cr.melt <- cdrp.profiles %>%
  select(one_of(feats)) %>%
  t %>%
  cor %>% 
  reshape2::melt() %>%
  left_join(., cdrp.profiles %>% select(-one_of(feats)), by = c("Var1" = "Metadata_broad_sample")) %>%
  left_join(., cdrp.profiles %>% select(-one_of(feats)), by = c("Var2" = "Metadata_broad_sample")) %>%
  mutate(same.moa = same.moa(MOA.x, MOA.y))

v11 <- cr.melt %>% 
  filter(as.character(Var1) < as.character(Var2)) %>%
  arrange(-value) %>%
  slice(1:round(n() * top.p)) %>%
  filter(same.moa) %>%
  NROW

v12 <- cr.melt %>% 
  filter(as.character(Var1) < as.character(Var2)) %>%
  arrange(-value) %>%
  slice(1:round(n() * top.p)) %>%
  filter(!same.moa) %>%
  NROW

v21 <- cr.melt %>% 
  filter(as.character(Var1) < as.character(Var2)) %>%
  arrange(-value) %>%
  slice((round(n() * top.p)+1):n()) %>%
  filter(same.moa) %>%
  NROW

v22 <- cr.melt %>% 
  filter(as.character(Var1) < as.character(Var2)) %>%
  arrange(-value) %>%
  slice((round(n() * top.p)+1):n()) %>%
  filter(!same.moa) %>%
  NROW

V <- rbind(c(v11, v12), c(v21, v22))

fisher.test(V, alternative = "greater")

cr <- cdrp.profiles %>%
  select(one_of(feats)) %>%
  t %>%
  cor

cr.melt %>% 
  filter(as.character(Var1) < as.character(Var2)) %>%
  arrange(-value) %>%
  slice(1:round(n() * top.p)) %>%
  filter(same.moa) %>%
  group_by(MOA.x) %>%
  tally() %>%
  arrange(-n) %>%
  htmlTable::htmlTable()

```

```{r, eval=F}

hcl <- hclust(as.dist(1 - cr), method = "average")
ct <- cutree(hcl, h = 1 - 0.5)
cls <- c()
for (i in 1:max(ct)) {
  cls <- c(cls, list(names(which(ct == i))))
}

for (i in 1:length(cls)) {
  moas.in.cls <- cdrp.profiles %>%
    filter(Metadata_broad_sample %in% cls[[i]]) %>%
    select(MOA) %>%
    as.matrix() %>%
    as.vector() %>%
    lapply(., function(x) str_split(x, ", ")[[1]]) %>%
    unlist 
    
    moa.freq <- prop.table(table(moas.in.cls)) * length(moas.in.cls)
    df <- as.data.frame(moa.freq)
    colnames(df) <- c(sprintf("MOA in cluster %d", i), "n")
    df <- df %>% arrange(-n)
    knitr::kable(df) %>% print
}

```


```{r, results='asis'}

cr.norm <- apply(cr, 1, function(x) (ecdf(x)(x)))
cr.norm <- (cr.norm + t(cr.norm))/2
rownames(cr.norm) <- colnames(cr.norm)

plot.within.MOA <- function(MOA.name, cor.thr = 0.90, plot.mat = F) {
  brds <- cdrp.profiles %>% 
    filter(str_detect(MOA, MOA.name)) %>%
    select(Metadata_broad_sample) %>% 
    as.matrix() %>% 
    as.vector()
  
  other.brds <- cdrp.profiles %>% 
    filter(!str_detect(MOA, MOA.name)) %>%
    select(Metadata_broad_sample) %>% 
    as.matrix() %>% 
    as.vector()

  if (plot.mat) {
    corrplot::corrplot(cr.norm[brds, brds], 
                       method = "color", 
                       order = "hclust", 
                       hclust.method = "average", 
                       is.corr = F, 
                       cl.lim = c(0, 1), 
                       col = colorRampPalette(c("green", "white", "darkred", "white", "darkblue"))(200))
  }
  
  x <- cr.norm[brds, brds] %>% as.dist() %>% as.vector()
  y <- cr.norm[brds, other.brds] %>% as.vector()
  
  z1 <- x
  z2 <- y
  
  v11 <- which(z1 > cor.thr) %>% length
  v12 <- which(z1 < cor.thr) %>% length
  v21 <- which(z2 > cor.thr) %>% length
  v22 <- which(z2 < cor.thr) %>% length
  
  V <- rbind(c(v11, v12), c(v21, v22))
  return(fisher.test(V, alternative = "greater")$p.value)
}

sig.moas <- cdrp.profiles %>%
  group_by(MOA) %>% 
  tally %>% 
  arrange(-n) %>% 
  filter(n >= 2 & MOA != "") %>% 
  select(MOA) %>%
  as.matrix() %>%
  as.vector() %>%
  lapply(., function(x) str_split(x, ", ")[[1]]) %>%
  unlist %>%
  unique()

sep.MOA <- function(x) {
  return(str_split(x[,"MOA"], ", ")[[1]])
}

MOA.list <- cdrp.profiles %>%
  select(Metadata_broad_sample, MOA) %>%
  group_by(Metadata_broad_sample) %>%
  do(data.frame(MOA.sep = sep.MOA(.))) %>%
  dplyr::rename(MOA = MOA.sep)

moa.corr <- sapply(sig.moas, plot.within.MOA)
moa.corr <- moa.corr %>% 
  as.data.frame() %>% 
  rename(!!"p.value" := !!".") %>%
  tibble::rownames_to_column("MOA") %>%
  mutate(p.value = p.adjust(p.value, method = "BH")) %>%
  left_join(., MOA.list %>% 
              group_by(MOA) %>% 
              tally %>% 
              ungroup(), 
            by = "MOA")

moa.corr %>% 
  filter(n >= 4) %>%
  mutate(is.consistent = p.value < 0.05) %>%
  arrange(p.value) %>%
  mutate(p.value = round(-log(p.value)/log(10), 2)) %>%
  rename(`-log(adj. p.value)` = p.value) %>%
  htmlTable::htmlTable()

```

```{r, eval=F}

gene.compound.cr <- readRDS("../results/master/2017-05-02_9796dc34/cr_melt_cp.rds")

extremest.value <- function(x) {
  mn <- min(x)
  mx <- max(x)
  if (abs(mn) > mx) {
    return(mn)
  } else {
    return(mx)
  }
} 

moa.names <- moa.corr %>% 
  filter(p.value < 0.05) %>%
  select(MOA) %>% 
  as.matrix() %>%
  as.vector()

for (MOA.name in moa.names) {
  brds <- cdrp.profiles %>% 
    filter(str_detect(MOA, MOA.name)) %>%
    select(CPD_NAME.x) %>% 
    mutate(CPD_NAME = str_to_lower(CPD_NAME.x)) 
  
    brds1 <- brds %>% mutate(CPD_NAME = str_replace(CPD_NAME, "-", ""))
    brds2 <- brds %>% mutate(CPD_NAME = str_replace(CPD_NAME, "-", " "))
    brds <- rbind(brds1, brds2, brds) %>% as.matrix() %>% as.vector() %>% unique
    
    cmpd.num <- gene.compound.cr %>% 
      filter(Var1 %in% brds) %>% 
      group_by(Var2) %>% 
      tally %>% 
      slice(1) %>%
      select(n) %>% 
      as.matrix() %>%
      as.vector()

  if (length(cmpd.num) > 0 && cmpd.num > 0) {    
    
    gene.compound.cr %>% 
      filter(Var1 %in% brds) %>% 
      group_by(Var2) %>% 
      summarise(value = extremest.value(value)) %>%
      arrange(-value) %>% 
      slice(c(1:5, (n()-4):n())) %>% 
      rename(gene = Var2) %>% 
      rename(!!sprintf("max corr. to %s in %d cmpd.", MOA.name, cmpd.num) := !!"value") %>%
      knitr::kable() %>%
      print
  }
}

```

