---
title: "Combine PGC1a screen and Cell Painting"
output: html_notebook
---

```{r message=FALSE}
library(magrittr)
library(glue)
library(tidyverse)
```


Load PGC1a screen

```{r}
screen <- read_csv("input/pgc1a_screen.csv.gz")
```

Load Cell Painting connections to `PPARGC1A_WT`

```{r}
connections <- read_csv("input/PPARGC1A_WT_2_compound_connections.csv.gz")
```
```{r}
set.seed(42)
screen %>% sample_n(10)
connections %>% sample_n(10)
```

```{r}
screen_connections <- inner_join(screen, connections)
```

Sadly this gets us nowhere

```{r}
count(screen_connections)
```
Let's try with the PUMA version

```{r}
screen_internal <- read_csv("input/puma_assay_data_CBIP_2139-01.csv.gz")
```

```{r}
screen_internal %>% 
  ggplot(aes(RESULT_VALUE, fill = as.factor(Class))) + 
  geom_histogram(bins = 100) + 
  facet_wrap(~Class, ncol = 1, scales = "free_y") 
```


```{r}
screen_internal_connections <-
  inner_join(screen_internal,
             connections,
             by = c("BRD_ID" = "BROAD_CPD_ID")) %>%
  mutate(
    activity_level =
      case_when(
        Class == 0 & RESULT_VALUE > 0 ~ "active_high",
        Class == 0 & RESULT_VALUE < 0 ~ "active_low",
        Class == 1 &
          RESULT_VALUE > 0 ~ "borderline_active_high",
        Class == 1 &
          RESULT_VALUE < 0 ~ "borderline_active_low",
        Class == 2 ~ "inactive",
        TRUE ~ NA_character_
      )
  ) %>%
  rename(pgc1a_assay_value = RESULT_VALUE,
         morphology_based_value = value)
```



```{r}
screen_internal_connections %>%
  ggplot(aes(activity_level, morphology_based_value)) + geom_boxplot() +
  ggtitle("Morphology based activity, stratified by activity in the PGC1a assay")

screen_internal_connections %>%
  ggplot(aes(activity_level, pgc1a_assay_value)) + geom_boxplot() +
  ggtitle("PGC1 activity score, stratified by activity in the PGC1a assay (sanity check)")
  
```


```{r}
screen_internal_connections %>%
  ggplot(aes(pgc1a_assay_value,
             morphology_based_value)) + geom_point(alpha = 0.1) +
  ggtitle(
    glue("Correlation between morphology and functional readout"),
    subtitle = glue('Spearman = {spearman}',
                    spearman =
                      round(
                        with(
                          screen_internal_connections,
                          cor(pgc1a_assay_value,
                              morphology_based_value,
                              method = "spearman")
                        ), 2
                      ))
  )
```



