---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE}
library(tidyverse)
library(magrittr)
library(platetools)
library(viridis)

knitr::opts_chunk$set(progress = FALSE)
```

Plate map for the actual plate shipped to Dr. Turbyville is "C-7120-01-CMP-005.txt"
This file contains mapping of the Broad IDs in a 384 well plate that were sent.

Originally requested layout for that plate is "Broad Plate Map_final_modified_brds.xlsx".
I had to make some substitutions because few BRDs were not available in requested batch.

The question is, do I need to put multiple poscons into the wells in rows K and L this time 
around? If not, making this plate would be much easier.


```{r}
first_batch_platemap <- read_tsv("../../docs/turbyville/C-7210-01-CMP-005.txt", col_names = T)
```

Plot the platemap
```{r}
library(platetools)
raw_map(data = ifelse(is.na(first_batch_platemap$broad_sample), "DMSO", "cpd"),
        well = first_batch_platemap$well_position,
        plate = 384) +
  ggtitle("C-7120-01-CMP-005") +
  theme_dark() +
  scale_fill_discrete()

```
```{r}
mta <- read_csv("../../docs/turbyville/MTA2017412_broad_ids.txt")
```

```{r}

mta_compounds <- 
  mta %>% 
  distinct(broad_sample) %>%
  mutate(pert_id = str_extract(broad_sample, "(BRD[-N][A-Z0-9]+)"))

first_batch_compounds <-
  first_batch_platemap %>% 
  distinct(broad_sample) %>%
  mutate(pert_id = str_extract(broad_sample, "(BRD[-N][A-Z0-9]+)"))

```


Compounds that were approved but not sent

```{r}
mta_compounds %>% select(pert_id) %>%
  setdiff(first_batch_compounds %>% select(pert_id))
```

Compounds that were sent but not approved

```{r}
first_batch_compounds %>% select(pert_id) %>% 
  setdiff(mta_compounds %>% select(pert_id))
```

```{r}
mta_and_first_batch_compounds <-
  first_batch_compounds %>% select(pert_id) %>% 
  union(mta_compounds %>% select(pert_id))

```

Create a dictionary to get pert_id from compounds names

```{r}
Pf.cmpd <- readRDS("../results/master/2017-04-20_64917c8b/Pf_annotated.rds")
Pf.cmpd$data %<>% mutate(CPD_NAME = ifelse(CPD_NAME != "", CPD_NAME, Metadata_broad_sample))
cpdname_pertid <- 
  Pf.cmpd$data %>% 
  ungroup() %>%
  select(CPD_NAME, Metadata_broad_sample) %>%
  mutate(pert_id = str_extract(Metadata_broad_sample, "(BRD[-N][A-Z0-9]+)")) %>%
  select(-Metadata_broad_sample)
```



Get full list of compounds from  2017-05-03_b1f643c4 
https://broadinstitute.atlassian.net/wiki/spaces/IP/pages/114669056/2017-04-20+Final+list+of+gene+compound+connections
2017-04-20 Final list of gene compound connections
(for simple correlation/anti-correlation matches)

Search for 
KRAS_WT.1
KRAS_G12V
HRAS_G12V


```{r}
library(rvest)
```

```{r}

predictions <- 
  read_html("../results/HEAD/2018-08-05_b1f643c4/predictions.html") %>%
  html_nodes("table") %>%
  .[c(41,46,47)]

parse_tables <- function(index) {
  predictions[[index]] %>% 
    html_table(fill = TRUE) %>%
    dplyr::select(Metadata_broad_sample, 
           rep.corr,
           score = `Corr.`) %>%
    mutate(pert_id = str_extract(Metadata_broad_sample, "(BRD[-N][A-Z0-9]+)")) %>%
    dplyr::select(-Metadata_broad_sample) %>%
    inner_join(cpdname_pertid) %>%
    select(-CPD_NAME) %>%
    left_join(
      mta_compounds %>% select(pert_id) %>% mutate(is_mta = TRUE)
      ) %>% 
    mutate(is_mta = !is.na(is_mta))    
}

HRAS_G12V <- parse_tables(1)
KRAS_G12V <- parse_tables(2)
KRAS_WT_1 <- parse_tables(3)

simple_correlations <-
  bind_rows(
    HRAS_G12V,
    KRAS_G12V,
    KRAS_WT_1
  )

```

How many unique compounds in this list?

```{r}
simple_correlations %>% distinct(pert_id) %>% count()
```

How many of these were in the MTA (+ extra that were sent)?

```{r}
simple_correlations %>%
  select(pert_id) %>%
  intersect(mta_and_first_batch_compounds) %>%
  count()
```


Verify that all the compounds listed in the for each of HRAS_G12V, KRAS_G12V, KRAS_WT_1 (30 each) 
where in the MTA (+ extra that were sent)
Result has 0 rows if true.

```{r}
simple_correlations %>%
  anti_join(mta_and_first_batch_compounds %>% select(pert_id))
```
Get full list of compounds selected based on differential WT-mutant profiles

```{r}
differential_scores <- 
  read_csv("../../results/master/2018-08-08_a3c67c03/diff_cmpds.csv") %>%
  mutate(pert_id = str_extract(`compound ID`, "(BRD[-N][A-Z0-9]+)"))

```

Select top k differential profiles

```{r}
k <- 200

differential_scores_top_k <- 
  differential_scores %>% 
  filter(abs(score) > 0.5) %>% 
  arrange(-abs(score)) %>%
  slice(1:k) %>% 
  select(pert_id) 

```

How many of these were in the MTA (+ extra that were sent)?

```{r}
differential_scores_top_k %>%
  select(pert_id) %>%
  intersect(mta_and_first_batch_compounds) %>%
  count()
```

Do compounds selected based on 
- simple correlations, and
- differential scores
explain everything?

Result has 0 rows if true.

If result has non-zero rows, the compounds listed are the unaccounted ones

```{r}
mta_and_first_batch_compounds %>%
  anti_join(simple_correlations %>% select(pert_id)) %>%
  anti_join(differential_scores_top_k)

```



