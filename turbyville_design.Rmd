---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE}
library(tidyverse)
library(platetools)
library(viridis)
```

Plate map for the actual plate shipped to Dr. Turbyville is "C-7120-01-CMP-005.txt"
This file contains mapping of the Broad IDs in a 384 well plate that were sent.

Originally requested layout for that plate is "Broad Plate Map_final_modified_brds.xlsx".
I had to make some substitutions because few BRDs were not available in requested batch.

The question is, do I need to put multiple poscons into the wells in rows K and L this time 
around? If not, making this plate would be much easier.


```{r}
first_batch_platemap <- read_tsv("../../docs/turbyville/C-7210-01-CMP-005.txt", col_names = T)
```

Plot the platemap
```{r}
library(platetools)
raw_map(data = ifelse(is.na(first_batch_platemap$broad_sample), "DMSO", "cpd"),
        well = first_batch_platemap$well_position,
        plate = 384) +
  ggtitle("C-7120-01-CMP-005") +
  theme_dark() +
  scale_fill_discrete()

```
```{r}
mta <- read_csv("../../docs/turbyville/MTA2017412_broad_ids.txt")
```

```{r}

mta_compounds <- 
  mta %>% 
  distinct(broad_sample) %>%
  mutate(pert_id = str_extract(broad_sample, "(BRD[-N][A-Z0-9]+)"))

first_batch_compounds <-
  first_batch_platemap %>% 
  distinct(broad_sample) %>%
  mutate(pert_id = str_extract(broad_sample, "(BRD[-N][A-Z0-9]+)"))

```


Compounds that were approved but not sent

```{r}
mta_compounds %>% select(pert_id) %>%
  setdiff(first_batch_compounds %>% select(pert_id))
```

Compounds that were sent but not approved

```{r}
first_batch_compounds %>% select(pert_id) %>% 
  setdiff(mta_compounds %>% select(pert_id))
```


Get full list of compounds from
https://broadinstitute.atlassian.net/wiki/spaces/IP/pages/115279646/2017-05-25+Compound+candidates+matching+to+KRAS+WT+but+not+to+KRAS+or+HRAS+mutant
2017-05-25 Compound candidates matching to KRAS_WT but not to KRAS or HRAS mutant
(for differential WT-mutant profiles)


```{r}
format_scores <- function(cr.melt) {
  cr.melt %>%
    filter(Var2 %in% c("KRAS_WT.1", "KRAS_G12V", "HRAS_G12V")) %>%
    group_by(Var1) %>%
    do(data.frame(WT_score = as.vector(.[which(.[,"Var2"] == "KRAS_WT.1"), "value"]), 
                  MUT1_score = as.vector(.[which(.[,"Var2"] == "KRAS_G12V"), "value"]), 
                  MUT2_score = as.vector(.[which(.[,"Var2"] == "HRAS_G12V"), "value"]))) %>%
    dplyr::rename(WT_score = value, 
                  MUT_KRAS_score = value.1,
                  MUT_HRAS_score = value.2) %>% 
    dplyr::arrange(-WT_score+(MUT_KRAS_score+MUT_HRAS_score)/2) %>%
    dplyr::mutate(WT_score = round(WT_score, 2), 
                  MUT_KRAS_score = round(MUT_KRAS_score, 2), 
                  MUT_HRAS_score = round(MUT_HRAS_score, 2)) %>%
    dplyr::filter(abs(WT_score) > 0.4)
}

```

```{r}
differential_all <- format_scores(readRDS("../results/HEAD/2018-08-03_95d88960/cr_melt_cp.rds"))

differential_bioactives <- format_scores(readRDS("../results/HEAD/2018-08-03_c4ea989d/cr_melt_cp.rds"))

```

```{r}
differential_all %<>% 
  dplyr::rename(CPD_NAME = Var1)

differential_bioactives %<>% 
  dplyr::rename(CPD_NAME = Var1)

```

Create a dictionary to get pert_id from compounds names

```{r}
Pf.cmpd <- readRDS("../results/master/2017-04-20_64917c8b/Pf_annotated.rds")
Pf.cmpd$data %<>% mutate(CPD_NAME = ifelse(CPD_NAME != "", CPD_NAME, Metadata_broad_sample))
cpdname_pertid <- 
  Pf.cmpd$data %>% 
  ungroup() %>%
  select(CPD_NAME, Metadata_broad_sample) %>%
  mutate(pert_id = str_extract(Metadata_broad_sample, "(BRD[-N][A-Z0-9]+)")) %>%
  select(-Metadata_broad_sample)
```

Perform lookup of pert_id
```{r}
differential_all %<>% 
  inner_join(cpdname_pertid)

differential_bioactives %<>% 
  inner_join(cpdname_pertid)
```

Is differential_bioactives a subset of differential_all. 
Result has 0 rows if true.

```{r}
differential_bioactives %>% 
  select(pert_id) %>% 
  setdiff(differential_all %>% select(pert_id))
```

```{r eval=FALSE}

differential_bioactives %<>% select(-is_mta)

differential_all %<>% select(-is_mta)
```

Create MUT_score

```{r}
differential_bioactives %<>% dplyr::mutate(MUT_score = (MUT_KRAS_score + MUT_HRAS_score)/2) 

differential_all %<>% dplyr::mutate(MUT_score = (MUT_KRAS_score + MUT_HRAS_score)/2) 
```


Indicate which compounds were approved (`is_mta`)

```{r}
differential_all %<>% 
  left_join(
    mta_compounds %>% select(pert_id) %>% mutate(is_mta = TRUE)
  ) %>% 
  mutate(is_mta = !is.na(is_mta)) %>%
  dplyr::arrange(-WT_score + MUT_score)

differential_bioactives %<>% 
  left_join(
    mta_compounds %>% select(pert_id) %>% mutate(is_mta = TRUE)
  ) %>% 
  mutate(is_mta = !is.na(is_mta)) %>%
  dplyr::arrange(-WT_score + MUT_score)

```

Figure out what was the rule to select compounds (which were then sent for approval)

```{r}
differential_all %>%
  ggplot(aes(WT_score, MUT_score, color = is_mta))  + geom_point()
```
```{r}
differential_all %>%
  ggplot(aes(WT_score, MUT_KRAS_score, color = is_mta))  + geom_point()

```
```{r}
differential_all %>%
  ggplot(aes(WT_score, MUT_HRAS_score, color = is_mta))  + geom_point()

```

```{r}
differential_all %>%
  ggplot() +
  geom_vline(aes(xintercept = WT_score - MUT_score, color = is_mta))

```

Get full list of compounds from  2017-05-03_b1f643c4 
https://broadinstitute.atlassian.net/wiki/spaces/IP/pages/114669056/2017-04-20+Final+list+of+gene+compound+connections
2017-04-20 Final list of gene compound connections
(for simple correlation/anti-correlation matches)

Search for 
KRAS_WT.1
KRAS_G12V
HRAS_G12V






